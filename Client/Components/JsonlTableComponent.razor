@using JsonlCompare.Client.Models
@using System.Reactive.Disposables
@using JsonlCompare.Client.Actions.SelectedJson
@using JsonlCompare.Client.Extensions
@using JsonlCompare.Client.Selectors
@using JsonlCompare.Client.Services
@using JsonlCompare.Client.Store.Json
@using JsonlCompare.Client.Store.JsonProperty
@using Newtonsoft.Json.Linq

@implements IDisposable

@inject IState<JsonState> jsonState
@inject IState<JsonPropertyState> jsonPropertyState

@inject IDispatcher dispatcher

<MatTable Items="@jsonState.Value.Jsons" class="mat-elevation-z5" ShowPaging="true" 
          AllowSelection="true" Striped="true" SelectionChanged="OnSelectionChanged"
          PageSize="25">
    <MatTableHeader>
        @foreach (var property in PropertyInfos())
        {
            if (property.Show && !property.HasChildren)
            {
                <th>@property.Path</th>
            }
        }
    </MatTableHeader>
    <MatTableRow>
        @foreach (var property in PropertyInfos())
        {
            if (property.Show && !property.HasChildren)
            {
                <td>@context.SelectToken(property.Path)?.ToString()</td>
            }
        }
    </MatTableRow>
</MatTable>

@code
{

    private IEnumerable<JsonPropertyInfo> PropertyInfos()
    {
        return jsonPropertyState.Value.PropertyInfos
            .SelectMany(x => x.EnumerateChildren());
    }

    protected override void OnInitialized()
    {
        jsonState.StateChanged += StateChangedEventHandler;
        jsonPropertyState.StateChanged += PropertyStateChangedEventHandler;
    }

    private void PropertyStateChangedEventHandler(object? sender, JsonPropertyState state)
    {
        StateHasChanged();
    }

    private void StateChangedEventHandler(object? sender, JsonState state)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        jsonState.StateChanged -= StateChangedEventHandler;
        jsonPropertyState.StateChanged -= PropertyStateChangedEventHandler;
    }

    private void OnSelectionChanged(object row)
    {
        dispatcher.Dispatch(new SelectedJsonSetAction((JObject)row));
    }
}
