@using JsonlCompare.Client.Interfaces
@using JsonlCompare.Client.Models
@using System.Reactive.Linq
@using System.Reactive.Disposables
@using JsonlCompare.Client.Store.Json
@using Newtonsoft.Json.Linq

@implements IDisposable

@inject IPropertyInfoService propertyInfoService
@inject IPropertyChangeService propertyChangeService
@inject IJsonContentChangeService jsonContentChangeService
@inject IJsonSelector jsonSelector

@inject IState<JsonState> jsonStore

<MatTable Items="@jsonStore.Value.Jsons" class="mat-elevation-z5" ShowPaging="true" 
          AllowSelection="true" Striped="true" SelectionChanged="OnSelectionChanged"
          PageSize="5">
    <MatTableHeader>
        @foreach (var property in PropertyInfos())
        {
            if (property.Show && !property.HasChildren)
            {
                <th>@property.Path</th>
            }
        }
    </MatTableHeader>
    <MatTableRow>
        @foreach (var property in PropertyInfos())
        {
            if (property.Show && !property.HasChildren)
            {
                <td>@context.SelectToken(property.Path)?.ToString()</td>
            }
        }
    </MatTableRow>
</MatTable>

@code
{
    private readonly CompositeDisposable disposable = new();
    
    private IEnumerable<JsonPropertyInfo> PropertyInfos()
    {
        var jsonPropertyInfos = propertyInfoService.PropertyInfos;
        return jsonPropertyInfos
            .SelectMany(EnumerateChildren);
    }

    private static IEnumerable<JsonPropertyInfo> EnumerateChildren(JsonPropertyInfo propertyInfo)
    {
        yield return propertyInfo;
        if (!propertyInfo.HasChildren) yield break;
        
        foreach (var propertyInfoChild in propertyInfo.Children)
        {
            foreach (var jsonPropertyInfo in EnumerateChildren(propertyInfoChild))
                yield return jsonPropertyInfo;
        }
    }

    protected override void OnInitialized()
    {
        jsonStore.StateChanged += StateChangedEventHandler;
        
        var jsonContentChangeSubscription = jsonContentChangeService.JsonContentChangeNotification
            .Do(_ => StateHasChanged())
            .Subscribe();
        
        disposable.Add(jsonContentChangeSubscription);
    }

    private void StateChangedEventHandler(object? sender, JsonState state)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        jsonStore.StateChanged -= StateChangedEventHandler;
    }

    private void OnSelectionChanged(object row)
    {
        jsonSelector.SetJson((JObject)row);
    }
}
